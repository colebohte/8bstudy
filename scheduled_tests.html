<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduled Tests & Assignments</title>
    <link rel="icon" type="image/x-icon" href="favi.png">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
                    }
                }
            }
        }
    </script>
    
    <!-- Custom Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* General styling for message area */
        .message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: left;
        }
        .message.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        .message.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .message.info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #60a5fa;
        }
        .hidden {
            display: none;
        }
        
        /* Spinner Styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* Tailwind blue-500 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        body {
            background-image: url('bg.jpg');
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            -webkit-backdrop-filter: blur(50px);
            backdrop-filter: blur(50px);
            min-height: 100vh;
        }

        /* Styling for the animated button (copied from general_resources.html) */
        .animated-button {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .animated-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="font-sans min-h-screen flex items-center justify-center p-4">
    <!-- Main Content Card -->
    <div class="max-w-md w-full bg-white rounded-xl shadow-2xl p-8 text-center" style="margin: 10px;">
        <h1 class="text-3xl font-extrabold mb-6 text-indigo-700">Scheduled Tests</h1>
        
        <!-- Loading Indicator with Spinner -->
        <div id="loading-indicator" class="text-gray-600 text-lg mb-4">
            <div class="spinner"></div>
            <span id="loading-text">Loading test schedule...</span>
        </div>

        <!-- Tests Content Area (initially hidden) -->
        <div id="tests-content" class="hidden text-left">
            
            <!-- Upcoming Tests List Container -->
            <h2 class="text-xl font-semibold mt-6 mb-2 text-green-700">Upcoming Tests</h2>
            <div id="upcoming-tests-list" class="space-y-4">
                <!-- Upcoming Tests will be dynamically injected here -->
            </div>
            
            <!-- Separator -->
            <div class="my-8 h-px bg-gray-200"></div>

            <!-- Completed Tests List Container -->
            <h2 class="text-xl font-semibold mt-6 mb-2 text-red-700">Completed Tests</h2>
            <div id="completed-tests-list" class="space-y-4">
                <!-- Completed Tests will be dynamically injected here -->
            </div>
            
        </div>

        <!-- Message Area for Errors/Feedback -->
        <div id="message-area" class="mt-4 p-3 rounded-lg text-sm text-left hidden"></div>

        <!-- Back to Dashboard Button (White, Animated, at the bottom) -->
        <a href="https://colebohte.github.io/librestudy" class="animated-button inline-flex items-center justify-center px-6 py-3 border border-gray-200 text-base font-medium rounded-lg text-indigo-700 bg-white shadow-md hover:bg-gray-50 mt-8 w-full">
            ‚Üê Back to Dashboard
        </a>
        
    </div>

    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>

    <script>
        console.log('--- SCRIPT START: Initializing Tests Application ---');

        /**
         * Formats a UTC date string (like 'YYYY-MM-DD') into a consistent DD-Mon-YYYY string.
         * @param {string} dateString - The date string from the database.
         * @returns {string} Formatted date string (DD-Mon-YYYY) or 'N/A'.
         */
        function getDisplayDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                 "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                
                // Use UTC components to ensure the date itself is correctly represented
                const year = date.getUTCFullYear();
                const monthIndex = date.getUTCMonth(); 
                const monthAbbr = months[monthIndex];
                const day = String(date.getUTCDate()).padStart(2, '0');
                
                return `${day}-${monthAbbr}-${year}`;
            } catch (e) {
                console.error("Failed to format date:", dateString, e);
                return 'Invalid Date';
            }
        }
        
        
        // --- Supabase Credentials ---
        const SUPABASE_URL = 'https://yysuwkdgluzouwdpoyjr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_NoOcmfhyN21l23ImU4UaaQ_NEWImOMh';
        const TABLE_NAME = 'ScheduledTests'; // <<< CORRECTED TABLE NAME
        const SELECT_COLUMNS = 'id, test_name, test_date'; // <<< UPDATED: Removed 'description'
        // --------------------------------------------------------

        let supabaseClient;
        const messageArea = document.getElementById('message-area');
        const loadingIndicator = document.getElementById('loading-indicator');
        const testsContent = document.getElementById('tests-content');
        const upcomingTestsList = document.getElementById('upcoming-tests-list');
        const completedTestsList = document.getElementById('completed-tests-list');

        /**
         * Displays a message to the user.
         * @param {string} text - The message text.
         * @param {'success' | 'error' | 'info'} type - The type of message.
         */
        function showMessage(text, type) {
            messageArea.textContent = text;
            let className = 'mt-4 p-3 rounded-lg text-sm text-left';
            if (type === 'success') {
                className += ' message success';
            } else if (type === 'error') {
                className += ' message error';
            } else if (type === 'info') {
                className += ' message info';
            }
            messageArea.className = className;
            messageArea.classList.remove('hidden');
            
            setTimeout(() => {
                messageArea.classList.add('hidden');
            }, 5000);
        }

        /**
         * Renders the list of tests fetched from Supabase, grouped by status.
         * @param {Array<Object>} tests - Array of test objects.
         */
        function renderTests(tests) {
            console.log(`[renderTests] Starting rendering for ${tests.length} tests.`);
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set to midnight for fair comparison

            upcomingTestsList.innerHTML = ''; 
            completedTestsList.innerHTML = ''; 

            let upcomingCount = 0;
            let completedCount = 0;

            if (tests.length === 0) {
                upcomingTestsList.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm italic">No tests have been scheduled yet.</p>';
                return;
            }

            // Sort tests by date: Upcoming ascending, Completed descending
            tests.sort((a, b) => {
                const dateA = new Date(a.test_date || '9999-12-31');
                const dateB = new Date(b.test_date || '9999-12-31');
                return dateA - dateB;
            });
            
            const upcoming = [];
            const completed = [];

            tests.forEach((test) => {
                const dateString = test.test_date;
                const displayDate = getDisplayDate(dateString);
                const name = test.test_name || 'Untitled Test';
                
                let isCompleted = false;
                let dateColor = 'text-gray-700';
                let icon = 'üìÖ';

                if (dateString) {
                    const testDate = new Date(dateString);
                    testDate.setHours(0, 0, 0, 0); 
                    
                    if (testDate < today) {
                        isCompleted = true;
                        dateColor = 'text-red-500';
                        icon = '‚úÖ'; // Using checkmark for completed
                    } else if (testDate.getTime() === today.getTime()) {
                        dateColor = 'text-orange-500 font-bold';
                        icon = 'üö®'; // Today!
                    } else {
                        dateColor = 'text-green-600 font-medium';
                        icon = 'üóìÔ∏è';
                    }
                } else {
                    icon = '‚ùì';
                }
                
                // Removed the description line, only showing name and date.
                const resourceItem = `
                    <div class="p-4 border border-indigo-200 rounded-lg shadow-md bg-white hover:shadow-lg transition duration-200 ease-in-out">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold text-indigo-700">${icon} ${name}</h3>
                            <span class="text-sm ${dateColor} ml-4 whitespace-nowrap">${isCompleted ? 'Ended:' : 'Due Date:'} ${displayDate}</span>
                        </div>
                    </div>
                `;

                if (isCompleted) {
                    completed.push(resourceItem);
                    completedCount++;
                } else {
                    upcoming.push(resourceItem);
                    upcomingCount++;
                }
            });

            // Reverse completed list to show most recent first
            upcomingTestsList.innerHTML = upcoming.join('');
            completedTestsList.innerHTML = completed.reverse().join('');
            
            // Add "No items" messages if necessary
            if (upcomingCount === 0) {
                upcomingTestsList.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm italic">You have no upcoming scheduled tests.</p>';
            }
            if (completedCount === 0) {
                completedTestsList.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm italic">No past tests recorded.</p>';
            }
        }

        /**
         * Fetches all data and triggers the render function.
         */
        async function fetchDataAndRender() {
            console.log('ACTION: Fetching and rendering data...');
            // Show loading spinner while fetching
            loadingIndicator.classList.remove('hidden');
            testsContent.classList.add('hidden'); // Hide content while loading

            const { data, error } = await supabaseClient
                .from(TABLE_NAME)
                .select(SELECT_COLUMNS)
                .order('test_date', { ascending: true }); // Order by date initially

            loadingIndicator.classList.add('hidden');
            
            if (error) {
                showMessage(`Error loading tests. Please check if the '${TABLE_NAME}' table exists and RLS is configured. Error: ${error.message}`, 'error');
                console.error('Supabase fetch error:', error);
            } else if (data) {
                renderTests(data);
                testsContent.classList.remove('hidden');
            } else {
                showMessage('Received an unexpected empty response from the database.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('EVENT: DOMContentLoaded fired. Starting initialization sequence.');

            try {
                // 1. Initialize Supabase client
                if (!window.supabase || !window.supabase.createClient) {
                    throw new Error('Supabase library not loaded correctly.');
                }
                
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('STEP 2: Supabase client initialized.');

                // 2. Perform initial data load
                await fetchDataAndRender();
                console.log('STEP 3: Initial data load complete.');

                // 3. Set up the real-time listener for live updates
                console.log(`STEP 4: Setting up real-time listener for table "${TABLE_NAME}"...`);
                
                supabaseClient.channel('scheduled_test_changes') // Updated channel name
                    .on('postgres_changes', { 
                        event: '*', // Listen to INSERT, UPDATE, DELETE
                        schema: 'public', 
                        table: TABLE_NAME // Correctly references 'ScheduledTests'
                    }, (payload) => {
                        console.log('Realtime change received:', payload);
                        const type = payload.eventType.toLowerCase();
                        showMessage(`Schedule updated: ${type.charAt(0).toUpperCase() + type.slice(1)} detected. Refreshing list...`, 'info');
                        // Re-fetch all data to ensure the list is consistently sorted and accurate
                        fetchDataAndRender(); 
                    })
                    .subscribe();

                console.log('--- SCRIPT END: Final execution path finished. Real-time listener active. ---');

            } catch (error) {
                console.error('FATAL ERROR: Initialization or connection failed:', error);
                // Ensure loading indicator is hidden even on failure
                loadingIndicator.classList.add('hidden');
                showMessage(`System Error during startup: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>






