<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>General Resources Viewer</title>
    <link rel="icon" type="image/png" href="/images/favicon.png">
    
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'ui-sans-serif', 'system-ui'],
                    }
                }
            }
        }
    </script>
    
    <!-- Custom Styles --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        /* General styling for message area */
        .message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            text-align: left;
        }
        .message.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #34d399;
        }
        .message.error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }
        .message.info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #60a5fa;
        }
        .hidden {
            display: none;
        }
        
        /* Spinner Styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* Tailwind blue-500 */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        body {
            background-image: url('bg.jpg');
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            -webkit-backdrop-filter: blur(50px);
            backdrop-filter: blur(50px);
            min-height: 100vh;
        }
        
        /* Layout classes for Expanded views (now the only view) */
        .resource-card {
            display: flex;
            flex-direction: column;
        }

        /* Expanded View - ensures stacked layout */
        .expanded .title-row {
            flex-direction: column;
            align-items: flex-start;
        }

        .expanded .link-row {
            flex-direction: column;
            align-items: flex-start;
            margin-top: 0.5rem;
            width: 100%;
        }

        /* Styling for the animated button (like index.html cards) */
        .animated-button {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .animated-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

    </style>
</head>
<body class="font-sans min-h-screen flex items-center justify-center p-4">
    <!-- Main Content Card --><div class="max-w-xl w-full bg-white rounded-xl shadow-2xl p-8 text-center" style="margin: 10px;">
        <h1 class="text-3xl font-extrabold mb-4 text-indigo-700">General Resources</h1>
        
        <!-- Loading Indicator --><div id="loading-indicator" class="text-gray-600 text-lg mb-4">
            <div class="spinner"></div>
            <span id="loading-text">Loading all resources...</span>
        </div>

        <!-- Resources Content Area (initially hidden) --><div id="resources-content" class="hidden text-left space-y-8 mb-8">
            <!-- Subject Groups will be dynamically injected here --></div>

        <!-- Message Area for Errors/Feedback --><div id="message-area" class="mt-4 p-3 rounded-lg text-sm text-left hidden"></div>

        <!-- Back to Dashboard Button (moved to bottom and animated) --><a href="https://colebohte.github.io/librestudy" class="animated-button inline-flex items-center justify-center px-6 py-3 border border-gray-200 text-base font-medium rounded-lg text-indigo-700 bg-white shadow-md hover:bg-gray-50 mt-8 w-full">
            ‚Üê Back to Dashboard
        </a>
    </div>

    <!-- Supabase JS Library --><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>

    <script>
        console.log('--- SCRIPT START: Initializing General Resource Application ---');

        // --- Configuration ---
        const TABLE_NAME = 'Resources'; 
        const SELECT_COLUMNS = 'id, res_name, res_link, subject'; 
        const SUPABASE_URL = 'https://yysuwkdgluzouwdpoyjr.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_NoOcmfhyN21l23ImU4UaaQ_NEWImOMh';
        // ---------------------

        let supabaseClient;

        const messageArea = document.getElementById('message-area');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resourcesContent = document.getElementById('resources-content');
        
        /**
         * Displays a message to the user.
         * @param {string} text - The message text.
         * @param {'error' | 'info'} type - The type of message.
         */
        function showMessage(text, type) {
            messageArea.textContent = text;
            let className = 'mt-4 p-3 rounded-lg text-sm text-left';
            if (type === 'error') {
                className += ' message error';
            } else if (type === 'info') {
                className += ' message info';
            }
            messageArea.className = className;
            messageArea.classList.remove('hidden');
            
            setTimeout(() => {
                messageArea.classList.add('hidden');
            }, 5000);
        }

        /**
         * Renders the list of resources, grouped by the 'subject' column.
         * @param {Array<Object>} resources - Array of resource objects.
         */
        function renderResources(resources) {
            console.log(`[renderResources] Rendering ${resources.length} resources in Expanded View.`);
            
            resourcesContent.innerHTML = ''; 

            if (resources.length === 0) {
                resourcesContent.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm italic">No general resources found.</p>';
                return;
            }
            
            const viewClass = 'expanded'; // Hardcoded to Expanded View
            
            // 1. Group resources by subject
            const resourcesBySubject = resources.reduce((acc, resource) => {
                const subjectName = (resource.subject || 'Uncategorized').trim();
                const displaySubjectName = subjectName.charAt(0).toUpperCase() + subjectName.slice(1);
                
                if (!acc[displaySubjectName]) {
                    acc[displaySubjectName] = [];
                }
                acc[displaySubjectName].push(resource);
                return acc;
            }, {});

            // 2. Iterate through groups and render
            Object.keys(resourcesBySubject).sort().forEach(subject => {
                const subjectResources = resourcesBySubject[subject];
                
                let subjectHTML = `<div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-700 border-b-2 border-indigo-200 pb-2 mb-4">${subject}</h2>
                    <div class="space-y-3">`;

                subjectResources.forEach(resource => {
                    const name = resource.res_name || 'Untitled Resource';
                    const link = resource.res_link;
                    
                    // Uses only the Expanded view structure (title, then link below)
                    const resourceItem = `
                        <div class="resource-card ${viewClass} p-4 border border-gray-200 rounded-lg shadow-sm bg-gray-50 hover:shadow-md transition duration-200 ease-in-out">
                            
                            <div class="title-row flex justify-between items-center">
                                <h3 class="text-lg font-bold text-gray-800">${name}</h3>
                            </div>
                            
                            <div class="link-row flex items-center text-sm mt-2">
                                ${link ? `<a href="${link}" target="_blank" class="text-indigo-600 hover:text-indigo-800 underline">View Link</a>` : '<span class="text-gray-400 italic">No Link Provided</span>'}
                            </div>
                        </div>
                    `;
                    subjectHTML += resourceItem;
                });

                subjectHTML += `</div></div>`;
                resourcesContent.innerHTML += subjectHTML;
            });
        }
        
        /**
         * Fetches all data and triggers the render function.
         */
        async function fetchDataAndRender() {
            console.log('ACTION: Fetching and rendering data...');
            // Show loading spinner while fetching
            loadingIndicator.classList.remove('hidden');
            resourcesContent.classList.add('hidden'); 

            const { data, error } = await supabaseClient
                .from(TABLE_NAME)
                .select(SELECT_COLUMNS)
                .order('subject', { ascending: true, nullsFirst: false }); 

            loadingIndicator.classList.add('hidden');
            
            if (error) {
                showMessage(`Error loading resources for '${TABLE_NAME}'. Please check configuration. Error: ${error.message}`, 'error');
                console.error('Supabase fetch error:', error);
            } else if (data) {
                // Store data for quick re-rendering on toggle (though toggle is removed, storing data is still useful)
                resourcesContent.dataset.resources = JSON.stringify(data);
                renderResources(data);
                resourcesContent.classList.remove('hidden');
            } else {
                showMessage('Received an unexpected empty response from the database.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('EVENT: DOMContentLoaded fired. Starting initialization sequence.');

            try {
                // 1. Initialize Supabase client
                if (!window.supabase || !window.supabase.createClient) {
                    throw new Error('Supabase library not loaded correctly.');
                }
                
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('STEP 2: Supabase client initialized.');

                // 2. Perform initial data load
                await fetchDataAndRender();
                console.log('STEP 3: Initial data load complete.');

                // 3. Set up the real-time listener for live updates
                console.log(`STEP 4: Setting up real-time listener for table "${TABLE_NAME}"...`);
                
                supabaseClient.channel(`${TABLE_NAME.toLowerCase()}_resources_changes`)
                    .on('postgres_changes', { 
                        event: '*', // Listen to INSERT, UPDATE, DELETE
                        schema: 'public', 
                        table: TABLE_NAME
                    }, (payload) => {
                        console.log('Realtime change received:', payload);
                        const type = payload.eventType.toLowerCase();
                        showMessage(`Resource updated: ${type.charAt(0).toUpperCase() + type.slice(1)} detected. Refreshing list...`, 'info');
                        fetchDataAndRender(); 
                    })
                    .subscribe();

                console.log('--- SCRIPT END: Final execution path finished. Real-time listener active. ---');

            } catch (error) {
                console.error('FATAL ERROR: Initialization or connection failed:', error);
                loadingIndicator.classList.add('hidden');
                showMessage(`System Error during startup: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>







